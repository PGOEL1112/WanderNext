<%- layout("layouts/boilerplate") %>

<style>
/* --------- PREMIUM WRAPPER --------- */
.owner-req-wrapper {
  max-width: 1200px;
  margin: 36px auto;
  padding: 20px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color: #0f172a;
}

/* HEADER */
.header-row {
  display: flex;
  justify-content: space-between;
  gap: 16px;
  align-items: center;
  margin-bottom: 18px;
}
.section-title {
  font-size: 1.85rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: #0b1220;
  display:flex;
  align-items:center;
  gap:10px;
}
.section-sub {
  color: #6b7280;
  font-weight:600;
}

/* LAYOUT */
.content-grid {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 22px;
  align-items: start;
}

/* LEFT: REQUEST LIST */
.left-col { }

.req-card {
  background: linear-gradient(180deg, #ffffff, #fbfdff);
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 16px;
  border: 1px solid rgba(15,23,42,0.04);
  box-shadow: 0 10px 30px rgba(2,6,23,0.06);
  transition: transform .18s ease, box-shadow .18s ease;
}
.req-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 40px rgba(2,6,23,0.09);
}

/* header row inside card */
.req-head {
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
}
.req-user {
  font-weight:800;
  color:#0f172a;
}
.req-meta {
  color:#475569;
  font-weight:600;
  font-size:0.92rem;
}

/* badges */
.badge-status {
  display:inline-block;
  border-radius:999px;
  padding:6px 12px;
  font-size:0.78rem;
  font-weight:800;
  letter-spacing:0.02em;
  text-transform:uppercase;
}
.badge-pending { background: linear-gradient(180deg,#fff7ed,#fff3db); color:#b45309; border:1px solid rgba(249,115,22,0.06); }
.badge-approved { background: linear-gradient(180deg,#ecfdf5,#dcfce7); color:#0f7a3a; border:1px solid rgba(16,185,129,0.06); }
.badge-rejected { background: linear-gradient(180deg,#fff1f2,#fee2e2); color:#991b1b; border:1px solid rgba(239,68,68,0.06); }

/* details grid */
.req-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 12px;
  color:#334155;
  font-weight:600;
  font-size:0.95rem;
}
.req-details b { color:#0b1220; font-weight:700; }

/* message */
.req-message {
  margin-top:12px;
  color:#475569;
  background: #f8fafc;
  border-radius:10px;
  padding:10px 12px;
  border:1px solid rgba(15,23,42,0.03);
  font-size:0.95rem;
  line-height:1.45;
}

/* actions */
.req-actions { display:flex; gap:10px; margin-top:12px; align-items:center; flex-wrap:wrap; }
.btn-approve {
  background: linear-gradient(90deg,#059669,#10b981);
  color: #fff;
  padding:8px 14px;
  border-radius:10px;
  border: none;
  font-weight:800;
  box-shadow: 0 10px 26px rgba(16,185,129,0.12);
  cursor:pointer;
}
.btn-approve:hover { transform: translateY(-2px); }

.reason-input {
  min-width: 220px;
  max-width: 360px;
}
.form-inline { display:flex; gap:8px; align-items:center; }

/* RIGHT: STATS / INFO PANEL */
.right-col {
  position: sticky;
  top: 28px;
}
.info-card {
  background: linear-gradient(180deg,#fff,#fbfdff);
  border-radius:12px;
  padding:16px;
  border: 1px solid rgba(15,23,42,0.04);
  box-shadow: 0 8px 26px rgba(2,6,23,0.05);
  margin-bottom: 14px;
}
.info-card h4 { margin:0 0 6px; font-size:1.05rem; color:#0b1220; }
.info-stat { font-size:1.65rem; font-weight:800; color:#0f172a; margin-top:6px; }

/* processed table */
.table-processed {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  border:1px solid rgba(15,23,42,0.04);
  box-shadow: 0 8px 20px rgba(2,6,23,0.04);
}
.table-processed table { width:100%; border-collapse:collapse; }
.table-processed th, .table-processed td { padding:10px 8px; text-align:left; vertical-align:middle; }
.table-processed thead th { font-weight:700; color:#475569; font-size:0.9rem; background:transparent; border-bottom:1px solid rgba(15,23,42,0.04); }
.table-processed tbody tr:hover { background: #fbfdff; transform: none; }

/* small utilities */
.small-muted { color:#6b7280; font-weight:600; font-size:0.92rem; }
.hr { height:1px; background:linear-gradient(90deg, rgba(15,23,42,0.03), rgba(15,23,42,0.02)); margin:12px 0; border-radius:2px; }

/* responsive */
@media (max-width: 980px) {
  .content-grid { grid-template-columns: 1fr; }
  .req-details { grid-template-columns: repeat(2,1fr); }
  .req-card { padding:14px; }
  .right-col { position: static; top: auto; }
}

/* form inputs */
.form-control-sm {
  padding:6px 8px;
  border-radius:8px;
  border:1px solid rgba(15,23,42,0.06);
  font-size:0.92rem;
}

/* focus states */
.req-card :is(button,input,textarea,select):focus {
  outline: 3px solid rgba(99,102,241,0.12);
  outline-offset: 3px;
  border-radius:8px;
}
</style>

<div class="owner-req-wrapper">

  <div class="header-row">
    <div>
      <h2 class="section-title"><i class="fa-solid fa-user-shield" aria-hidden="true"></i> Owner Requests</h2>
      <div class="section-sub">Review owner onboarding requests and take action.</div>
    </div>

    <div class="small-muted">
      Pending: <strong><%= pending?.length || 0 %></strong> &nbsp;•&nbsp;
      Processed: <strong><%= processed?.length || 0 %></strong>
    </div>
  </div>

  <div class="content-grid">
    <!-- LEFT -->
    <div class="left-col">

      <h5 class="small-muted mb-2">Pending Requests</h5>

      <% if (!pending || pending.length === 0) { %>
        <div class="req-card">
          <div class="req-head">
            <div>
              <div class="req-user">No pending requests</div>
              <div class="req-meta">You're all caught up — no owner requests in the queue.</div>
            </div>
            <div><span class="badge-status badge-approved">—</span></div>
          </div>
        </div>
      <% } %>

      <% pending.forEach(r => { %>
        <div class="req-card" id="req-<%= r._id %>">
          <div class="req-head">
            <div>
              <div class="req-user">@<%= r.user.username %> <span class="small-muted">· <%= r.user.email %></span></div>
              <div class="req-meta">Submitted: <%= r.createdAt.toLocaleString("en-IN") %></div>
            </div>

            <div>
              <span class="badge-status badge-pending" aria-hidden="true">Pending</span>
            </div>
          </div>

          <div class="hr" role="separator" aria-hidden="true"></div>

          <div class="req-details" role="group" aria-label="Request details">
            <div>
              <div><b>Name</b></div>
              <div class="small-muted"><%= r.fullName %></div>
            </div>
            <div>
              <div><b>Phone</b></div>
              <div class="small-muted"><%= r.phone || '-' %></div>
            </div>
            <div>
              <div><b>City</b></div>
              <div class="small-muted"><%= r.city || '-' %></div>
            </div>

            <div>
              <div><b>Address</b></div>
              <div class="small-muted"><%= r.address || '-' %></div>
            </div>
            <div>
              <div><b>Property Type</b></div>
              <div class="small-muted"><%= r.propertyType || 'N/A' %></div>
            </div>
            <div>
              <div><b>Count</b></div>
              <div class="small-muted"><%= r.propertyCount || 0 %></div>
            </div>
          </div>

          <% if (r.message) { %>
            <div class="req-message" aria-label="Applicant message">
              <strong>Message</strong>
              <div style="margin-top:6px;"><%= r.message %></div>
            </div>
          <% } %>

          <div class="req-actions" role="region" aria-label="Actions">
            <!-- Approve form -->
            <form class="inline-form" action="/admin/owners/<%= r._id %>/approve" method="POST" onsubmit="return confirmApprove(event, '<%= r.user.username %>')">
              <button type="submit" class="btn-approve" title="Approve owner request">
                <i class="fa-solid fa-check me-1" aria-hidden="true"></i> Approve
              </button>
            </form>

            <!-- Reject form -->
            <form class="form-inline" action="/admin/owners/<%= r._id %>/reject" method="POST" onsubmit="return confirmReject(event, '<%= r.user.username %>')">
              <input type="text" name="reason" class="form-control-sm reason-input" placeholder="Reason (optional)" aria-label="Reject reason">
              <button type="submit" class="btn btn-outline-danger" style="padding:8px 12px; border-radius:10px; font-weight:800;">
                <i class="fa-solid fa-xmark me-1" aria-hidden="true"></i> Reject
              </button>
            </form>
          </div>
        </div>
      <% }) %>
        
    </div>

    <!-- RIGHT -->
    <aside class="right-col">
      <div class="info-card" aria-hidden="false">
        <h4>Quick Stats</h4>
        <div class="info-stat"><%= pending?.length || 0 %> Pending</div>
        <div class="small-muted" style="margin-top:8px;">Processed: <strong><%= processed?.length || 0 %></strong></div>
      </div>

      <div class="table-processed" aria-label="Processed owner requests">
        <h5 style="margin:0 0 8px; font-weight:800; color:#0b1220;">Processed Requests</h5>

        <% if (!processed || processed.length === 0) { %>
          <div class="small-muted">No processed requests yet.</div>
        <% } else { %>
          <div style="max-height:320px; overflow:auto; margin-top:8px;">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:48%;">User</th>
                  <th style="width:26%;">Status</th>
                  <th style="width:26%;">Reviewed</th>
                </tr>
              </thead>
              <tbody>
                <% processed.forEach(r => { %>
                  <tr>
                    <td>
                        <div style="font-weight:800;">
                          <a href="/admin/owners/<%= r._id %>" 
                            style="color:#0f172a;text-decoration:none;">
                            @<%= r.user?.username || "Unknown User" %>
                          </a>
                        </div>
                        <div class="small-muted"><%= r.user?.email || "No Email" %></div>
                      </td>
                    <td>
                      <span class="badge-status <%= r.status === 'approved' ? 'badge-approved' : 'badge-rejected' %>">
                        <%= (r.status || '').toUpperCase() %>
                      </span>
                    </td>
                    <td>
                      <div class="small-muted"><%= r.reviewedAt ? r.reviewedAt.toLocaleString("en-IN") : '-' %></div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </aside>
  </div> <!-- content-grid -->

</div> <!-- wrapper -->

<script>
  // confirmation helpers
  function confirmApprove(e, username) {
    // optional: show a nicer confirm or modal
    if(!confirm('Approve owner request for ' + username + ' ?')) {
      e.preventDefault();
      return false;
    }
    return true;
  }

  function confirmReject(e, username) {
    if(!confirm('Reject owner request for ' + username + ' ?\\n(You can provide a reason in the input)')) {
      e.preventDefault();
      return false;
    }
    return true;
  }

  // small accessibility: focus first pending input when available
  (function focusFirstReason(){
    try {
      const first = document.querySelector('.reason-input');
      if(first) first.setAttribute('aria-label','Reject reason for first pending request'), first.focus();
    } catch(e){}
  })();
</script>
