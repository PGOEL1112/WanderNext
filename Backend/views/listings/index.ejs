<%- layout("layouts/boilerplate") %>

<%
  const safeSort = sort || "";
  const safeAmenity = amenity || [];
  const safeCategory = category || "all";
  const safeSearch = search || "";
%>

<style>
/* =========================================================
   THEME VARIABLES
   ========================================================= */
:root{
  --accent:#ffb020;
  --accent-soft:#fff4dc;

  --bg:#f9fafb;
  --card:#ffffff;

  --text:#111827;
  --muted:#6b7280;

  --border:#e5e7eb;

  --shadow-sm:0 1px 4px rgba(0,0,0,.05);
  --shadow-md:0 8px 22px rgba(0,0,0,.08);
}

body{
  background:var(--bg);
  color:var(--text);
}

/* =========================================================
   FILTER BAR
   ========================================================= */
.premium-filter{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  box-shadow:var(--shadow-sm);
  position:relative; 
  overflow:visible;
}

/* inputs */
.form-control,
.form-select{
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:500;
  font-size:.9rem;
}

/* search input with icon */
.input-with-icon{
  position:relative;
}
.input-with-icon i{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  font-size:.85rem;
  color:#9ca3af;
  pointer-events:none;
}
.input-with-icon input{
  padding-left:38px !important;
}

/* =========================================================
   AMENITY + CATEGORY CHIPS
   ========================================================= */
.amenity-chip,
.cat-pill{
  background:#fff;
  border:1px solid var(--border);
  color:var(--muted);
  font-weight:600;
  border-radius:999px;
  padding:8px 16px;
  font-size:.85rem;
  transition:.15s ease;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

.amenity-chip:hover,
.cat-pill:hover{
  background:var(--accent-soft);
  border-color:#fde68a;
  color:#111;
}

.amenity-chip.active,
.cat-pill.active{
  background:var(--accent-soft);
  border-color:var(--accent);
  color:#111;
}

/* =========================================================
   LISTING CARD
   ========================================================= */
.listing-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  box-shadow:var(--shadow-sm);
  transition:.25s ease;
}
.listing-card:hover{
  box-shadow:var(--shadow-md);
}

/* image */
.img-wrap img{
  width:100%;
  height:220px;
  object-fit:cover;
}

/* body */
.listing-body{
  padding:16px;
}

.listing-title{
  font-size:1.05rem;
  font-weight:600;
}
.listing-title a{
  color:var(--text);
  text-decoration:none;
}

.meta{
  font-size:.85rem;
  color:var(--muted);
}

/* =========================================================
   PRICE + GST
   ========================================================= */
.price{
  color:var(--accent);
  font-size:1.15rem;
  font-weight:700;
}

.price-sub{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:.75rem;
  color:var(--muted);
}

.gst-badge{
  font-size:.7rem;
  font-weight:700;
  padding:3px 8px;
  border-radius:999px;
  background:#fff7ed;
  color:#92400e;
  border:1px solid #fed7aa;
  text-transform:uppercase;
}

/* =========================================================
   AMENITIES BADGES
   ========================================================= */
.amenity{
  font-size:.75rem;
  background:#f3f4f6;
  border-radius:999px;
  padding:5px 10px;
  color:var(--muted);
}

.amenity.more{
  background:#fef3c7;
  border:1px solid #fde68a;
  color:#92400e;
  font-weight:600;
}

/* =========================================================
   BUTTONS
   ========================================================= */
.btn-primary-sm{
  background:#fff;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:10px;
  font-weight:600;
  padding:10px;
  text-align:center;
}
.btn-primary-sm:hover{
  background:#f9fafb;
}

.btn-cta-sm{
  background:var(--accent);
  color:#111;
  border-radius:10px;
  font-weight:700;
  padding:10px;
  text-align:center;
}
.btn-cta-sm:hover{
  opacity:.9;
}

/* save */
.save-btn{
  background:#fff;
  border:1px solid var(--border);
  border-radius:50%;
  padding:8px;
}
.save-btn.saved{
  color:#ef4444;
  border-color:#fecaca;
}

/* top pick */
.top-pick{
  background:#fff;
  border:1px solid var(--border);
  font-size:.75rem;
  font-weight:600;
  padding:6px 10px;
  border-radius:10px;
  box-shadow:var(--shadow-sm);
}

/* =========================================================
   APPLY BUTTON
   ========================================================= */
.btn-apply{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 16px;
  border-radius:10px;
  background:#ffb020;
  color:#111;
  font-size:.9rem;
  font-weight:700;
  border:none;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(255,176,32,.35);
  transition:.2s ease;
}
.btn-apply:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(255,176,32,.45);
}
.btn-apply:active{
  transform:translateY(0);
}

/* =========================================================
   PAGINATION
   ========================================================= */
.pagination .page-link{
  border-radius:8px;
  border:1px solid var(--border);
  color:var(--text);
}
.pagination .active .page-link{
  background:var(--accent);
  border:none;
}

/* =========================================================
   RESPONSIVE — TABLET & MOBILE
   ========================================================= */

/* FILTER STACK */
@media (max-width:768px){
  #filterForm{
    flex-direction:column;
    gap:14px;
  }

  .filter-left,
  .filter-right{
    width:100% !important;
    min-width:100% !important;
  }

  .filter-right{
    justify-content:flex-start;
  }

  .filter-right select,
  .gst-toggle{
    width:100%;
  }

  /* amenities horizontal scroll */
  /* === AMENITIES SCROLL FIX === */
.amenities-control{
  display:flex;
  flex-wrap:wrap;
  gap:8px;

  width:100%;
  max-width:100%;

  overflow:visible;   /* allow page scroll */
}


  .amenity-chip{
    flex-shrink:0;
    white-space:nowrap;
  }
}

/* CATEGORY PILLS */
.category-filter{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

@media (max-width:768px){
  .amenities-control{
    flex-wrap:nowrap;
    overflow-x:auto;
    padding-bottom:6px;
  }

  .amenity-chip{
    flex-shrink:0;
  }
}

@media (max-width:768px){
  .category-filter{
    flex-wrap:nowrap;
    overflow-x:auto;
    padding-bottom:8px;
  }
  .cat-pill{
    flex-shrink:0;
    white-space:nowrap;
  }
}

/* LISTING CARD MOBILE */
@media (max-width:768px){
  .img-wrap img{
    height:170px;
  }

  .listing-title{
    font-size:1rem;
  }

  .listing-actions{
    flex-direction:column;
  }

  .listing-actions a{
    width:100% !important;
  }

  .title-row{
    gap:10px;
  }
}

/* SMALL PHONES */
@media (max-width:480px){
  .listing-body{
    padding:12px;
  }

  .amenity{
    font-size:.7rem;
    padding:4px 8px;
  }

  .price-row{
    flex-direction:column;
    align-items:flex-start !important;
    gap:4px;
  }

  .btn-primary-sm,
  .btn-cta-sm{
    padding:12px;
    font-size:.9rem;
  }
}
</style>

<div class="listings-page container" style="max-width:1180px; margin: 18px auto;">

  <!-- ---------------- FILTER BAR ---------------- -->
  <form id="filterForm" action="/listings" method="GET"
        class="premium-filter d-flex align-items-start gap-3 flex-wrap">

    <div class="filter-left" style="flex:1; min-width:220px;">
      <label class="visually-hidden">Search listings</label>

      <!-- FIXED SEARCH ICON INSIDE INPUT -->
      <div class="input-with-icon">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="searchInput" name="search" class="form-control"
               placeholder="Search by title, city or keyword..." value="<%= safeSearch %>">
      </div>

      <div class="mt-2 d-flex gap-2">
        <input name="minPrice" type="number" class="form-control"
               placeholder="Min ₹" value="<%= minPrice || '' %>">
        <input name="maxPrice" type="number" class="form-control"
               placeholder="Max ₹" value="<%= maxPrice || '' %>">
      </div>
    </div>

    <div class="filter-right" style="min-width:320px; display:flex; gap:8px; flex-wrap:wrap;">

      <select id="sortSelect" name="sort" class="form-select">
        <option value="">Sort By</option>
        <option value="priceLow" <%= safeSort==='priceLow'?'selected':'' %>>Price: Low → High</option>
        <option value="priceHigh" <%= safeSort==='priceHigh'?'selected':'' %>>Price: High → Low</option>
        <option value="recent" <%= safeSort==='recent'?'selected':'' %>>Most Recent</option>
      </select>

      <div class="gst-toggle">
        <label class="me-2" style="font-weight:700;">GST</label>
        <input id="gstToggle" type="checkbox" name="gst" value="on" <%= gst?'checked':'' %> />
      </div>

      <!-- Amenity chips -->
      <div id="amenitiesControl" class="amenities-control">
        <% const allAmenities=[
          {k:'wifi',icon:'fa-wifi',label:'WiFi'},
          {k:'parking',icon:'fa-square-parking',label:'Parking'},
          {k:'pool',icon:'fa-person-swimming',label:'Pool'},
          {k:'gym',icon:'fa-dumbbell',label:'Gym'},
          {k:'ac',icon:'fa-snowflake',label:'AC'},
          {k:'restaurant',icon:'fa-utensils',label:'Dining'}
        ]; %>

        <% allAmenities.forEach(a=>{ 
             const active = Array.isArray(safeAmenity) ? safeAmenity.includes(a.k) : (safeAmenity===a.k);
        %>
        <button type="button" class="amenity-chip <%= active?'active':'' %>" data-value="<%= a.k %>">
          <i class="fa-solid <%= a.icon %>"></i><%= a.label %>
        </button>
        <% }) %>
      </div>

      <input type="hidden" name="category" value="<%= safeCategory %>">

      <div id="amenitiesHiddenInputs">
        <% if (Array.isArray(safeAmenity)) safeAmenity.forEach(a=>{ %>
          <input type="hidden" name="amenity" value="<%= a %>">
        <% }) %>
      </div>

      <button class="btn-apply">
        <i class="fa-solid fa-filter me-2"></i> Apply
      </button>


      <a href="/listings" class="btn btn-reset"
         style="background:#fff; border:1px solid var(--border-light); color:#111; border-radius:10px; padding:10px 14px;">
        <i class="fa-solid fa-rotate-left me-1"></i> Reset
      </a>

    </div>
  </form>

  <!-- ---------------- CATEGORY PILLS ---------------- -->
  <div class="category-filter mt-3 mb-2">
    <% const categoriesList=[
      {id:"all",icon:"fa-globe",label:"All"},
      {id:"beach",icon:"fa-umbrella-beach",label:"Beach"},
      {id:"mountain",icon:"fa-mountain",label:"Mountain"},
      {id:"villa",icon:"fa-hotel",label:"Villa"},
      {id:"trending",icon:"fa-fire",label:"Trending"},
      {id:"city",icon:"fa-city",label:"City"},
      {id:"camping",icon:"fa-campground",label:"Camping"},
      {id:"luxury",icon:"fa-gem",label:"Luxury"},
      {id:"historic",icon:"fa-landmark",label:"Historic"},
    ] %>

    <% categoriesList.forEach(cat=>{ %>
      <a class="cat-pill <%= safeCategory===cat.id?'active':'' %>"
         href="/listings?category=<%= cat.id %>&search=<%= safeSearch %>&minPrice=<%= minPrice||'' %>&maxPrice=<%= maxPrice||'' %>&sort=<%= safeSort %>">
        <i class="fa-solid <%= cat.icon %>"></i> <%= cat.label %>
      </a>
    <% }) %>
  </div>

  <!-- ---------------- LISTINGS GRID ---------------- -->
  <div class="row g-4 mt-3">

    <% if (!allListings.length){ %>
      <div class="col-12 text-center p-5" style="background:#fff; border-radius:14px; border:1px solid var(--border-light); box-shadow:0 10px 24px rgba(0,0,0,.08);">
        <h4 style="color:#111;">No listings found</h4>
        <p style="color:var(--muted); font-weight:600;">Try clearing filters or changing search.</p>
      </div>
    <% } %>

    <% allListings.forEach(listing=>{ %>
      <div class="col-lg-4 col-md-6">
        <article class="listing-card">

          <a href="/listings/<%= listing._id %>" class="img-wrap">
            <img src="<%= listing.image?.url || '/images/fallback.jpg' %>" style="width:100%; height:210px; object-fit:cover;">
            <% if(listing.topPick){ %>
              <div class="top-pick"><i class="fa-solid fa-star"></i> Top pick</div>
            <% } %>
          </a>

          <div class="listing-body p-3">

            <div class="title-row d-flex justify-content-between">
              <h3 class="listing-title">
                <a href="/listings/<%= listing._id %>">
                  <i class="fa-solid fa-hotel me-1"></i> <%= listing.title %>
                </a>
              </h3>

              <% if(currentUser){ %>
                <form class="save-form" data-id="<%= listing._id %>">
                  <% const saved = currentUser.savedListings?.some(id=>String(id)===String(listing._id)); %>
                  <button type="submit" class="save-btn <%= saved?'saved':'' %>">
                    <i class="fa-solid <%= saved?'fa-heart':'fa-heart-circle-plus' %>"></i>
                  </button>
                </form>
              <% } %>

            </div>

            <p class="meta"><i class="fa-solid fa-location-dot me-1"></i> <%= listing.location %>, <%= listing.country %></p>

            <div class="price-row d-flex align-items-baseline gap-2">
              <div class="price">
                ₹<%= gst ? Math.round(listing.price*1.18).toLocaleString("en-IN") : Number(listing.price).toLocaleString("en-IN") %>
              </div>

              <div class="price-sub">
                / night
                <% if(gst){ %>
                  <span class="gst-badge">GST incl</span>
                <% } %>
              </div>
            </div>

            <% if(listing.amenities?.length){ %>
              <div class="amenities-list d-flex gap-2 flex-wrap mt-2">
                <% listing.amenities.slice(0,3).forEach(a=>{ %>
                  <span class="amenity"><i class="fa-solid fa-check"></i> <%= a %></span>
                <% }) %>
                <% if(listing.amenities.length>3){ %>
                  <span class="amenity more">+<%= listing.amenities.length-3 %> more</span>
                <% } %>
              </div>
            <% } %>

            <div class="listing-actions d-flex gap-2 mt-3">

              <!-- BETTER VIEW BUTTON -->
              <a class="btn-primary-sm w-50 text-center" href="/listings/<%= listing._id %>">
                <i class="fa-solid fa-eye me-1"></i> View
              </a>

              <!-- BETTER BOOK BUTTON -->
              <% if(currentUser){ %>
                <a href="/bookings/listings/<%= listing._id %>/premium-book"
                   class="btn-cta-sm w-50 text-center">
                  <i class="fa-solid fa-credit-card me-1"></i> Book
                </a>
              <% } else { %>
                <a href="/login" class="btn-cta-sm w-50 text-center">
                  <i class="fa-solid fa-right-to-bracket me-1"></i> Book
                </a>
              <% } %>

            </div>

          </div>

        </article>
      </div>
    <% }) %>

  </div>

</div>

<!-- ========================= SCRIPTS (client) ========================= -->
<script>
(function () {
  // debounce util
  function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait)} }

  const filterForm = document.getElementById('filterForm');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const gstToggle = document.getElementById('gstToggle');

  // amenities UI
  const amenitiesControl = document.getElementById('amenitiesControl');
  const hiddenInputsContainer = document.getElementById('amenitiesHiddenInputs');

  function rebuildHiddenAmenityInputs(selectedValues) {
    hiddenInputsContainer.innerHTML = '';
    selectedValues.forEach(v => {
      const input = document.createElement('input');
      input.type = 'hidden'; input.name = 'amenity'; input.value = v;
      hiddenInputsContainer.appendChild(input);
    });
  }

  // initialize selected from server
  const initialAmenityInputs = Array.from(hiddenInputsContainer.querySelectorAll('input[name="amenity"]')).map(i=>i.value);
  let selectedAmenities = initialAmenityInputs.slice();

  amenitiesControl?.addEventListener('click', (e) => {
    const btn = e.target.closest('.amenity-chip');
    if (!btn) return;
    const value = btn.dataset.value;
    if (!value) return;

    if (selectedAmenities.includes(value)) {
      selectedAmenities = selectedAmenities.filter(x => x !== value);
      btn.classList.remove('active');
    } else {
      selectedAmenities.push(value);
      btn.classList.add('active');
    }
    rebuildHiddenAmenityInputs(selectedAmenities);
    debounce(()=> filterForm.submit(), 380)();
  });

  // basic submit triggers
  searchInput?.addEventListener('input', debounce(()=> filterForm.submit(), 650));
  searchInput?.addEventListener('keydown', (e)=> { if (e.key === 'Enter'){ e.preventDefault(); filterForm.submit(); }});
  sortSelect?.addEventListener('change', ()=> filterForm.submit());
  gstToggle?.addEventListener('change', ()=> filterForm.submit());
  document.querySelectorAll('input[name="minPrice"], input[name="maxPrice"]').forEach(inp => inp.addEventListener('change', ()=> filterForm.submit()));

  // Save / Unsave listing
  async function handleSaveFormSubmit(e){
    e.preventDefault();
    const form = e.currentTarget;
    const id = form.dataset.id;
    const btn = form.querySelector('button');
    try {
      const res = await fetch(`/listings/${id}/save`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const data = await res.json();
      if (data.saved) {
        btn.innerHTML = '<i class="fa-solid fa-heart"></i>';
        btn.classList.add('saved');
        btn.setAttribute('aria-pressed','true');
      } else {
        btn.innerHTML = '<i class="fa-solid fa-heart-circle-plus"></i>';
        btn.classList.remove('saved');
        btn.setAttribute('aria-pressed','false');
      }
    } catch (err) {
      if (err && err.status === 401) { window.location.href = '/login'; }
      else console.error(err);
    }
  }

  function attachSaveListeners(){
    document.querySelectorAll('.save-form').forEach(f=>{
      f.removeEventListener('submit', handleSaveFormSubmit);
      f.addEventListener('submit', handleSaveFormSubmit);
    });
  }
  attachSaveListeners();

})();
</script>