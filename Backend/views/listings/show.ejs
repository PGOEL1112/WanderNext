<%- layout("layouts/boilerplate") %>

<%
  // expected server variables: listing, currentUser, mapToken
  const reviews = Array.isArray(listing.reviews) ? listing.reviews : [];
  const reviewCount = reviews.length;
  const avgRating = reviewCount ? (reviews.reduce((s,r)=>s + (r.rating||0), 0) / reviewCount) : 0;
  const avgRounded = Math.round(avgRating * 10) / 10;
  const ratingCounts = [5,4,3,2,1].map(star => reviews.filter(r=>r.rating===star).length);
%>

<style>

  :root{
  --accent: #ffb020;
  --accent-2: #ff7a59;
  --muted: #6b7280;
  --muted-2: #94a3b8;
  --bg-card: #ffffff;
  --glass-border: rgba(15,23,42,0.06);
  --card-radius: 14px;
  --soft-shadow: 0 10px 30px rgba(2,6,23,0.06);
  --deep-shadow: 0 18px 50px rgba(2,6,23,0.09);
  --text-dark: #0f172a;
  --font-weight-light: 400;
}

/* container */
.detail-page { max-width:1100px; margin:28px auto; padding:18px; color:var(--text-dark); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; font-weight:var(--font-weight-light); }

/* top card */
.top-card { display:grid; grid-template-columns:1fr 420px; gap:22px; background:var(--bg-card); border-radius:var(--card-radius); padding:18px; border:1px solid var(--glass-border); box-shadow:var(--soft-shadow); }
.left-column, .right-column { min-width:0; }

/* hero image */
.hero-image { border-radius:12px; overflow:hidden; min-height:360px; position:relative; background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01)); display:flex; align-items:center; justify-content:center; }
.hero-image img { width:100%; height:100%; object-fit:cover; display:block; transition:transform .45s ease; }
.hero-image img:hover { transform:scale(1.02); }
.badge-top { position:absolute; left:12px; top:12px; background:linear-gradient(90deg, rgba(255,255,255,0.92), rgba(255,255,255,0.85)); color:var(--text-dark); padding:8px 12px; border-radius:10px; font-weight:700; border:1px solid rgba(0,0,0,0.04); box-shadow:0 8px 26px rgba(2,6,23,0.06); }

/* quick meta */
.quick-meta { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
.quick-pill { background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98)); border:1px solid rgba(15,23,42,0.04); padding:8px 12px; border-radius:10px; font-weight:700; display:flex; gap:8px; align-items:center; }

/* right */
.listing-title { font-size:1.6rem; margin:0; font-weight:600; color:var(--text-dark); }
.listing-sub { color:var(--muted); font-weight:600; display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px; }
.price-row { margin-top:8px; display:flex; align-items:center; gap:10px; }
.price-value { font-size:1.5rem; font-weight:800; color:var(--accent); }
.price-sub { color:var(--muted-2); font-weight:600; }
.desc { color:#334155; margin-top:10px; line-height:1.6; font-weight:400; }

/* amenities */
.amenities { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
.amenity { background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,250,0.96)); padding:8px 10px; border-radius:999px; border:1px solid rgba(15,23,42,0.04); font-weight:700; display:flex; gap:8px; align-items:center; color:var(--text-dark); }
.amenity i { color:var(--accent); }

/* action buttons */
.actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }

/* map + popup: new layout */
.location-block { margin-top:18px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98)); border-radius:12px; padding:12px; border:1px solid rgba(15,23,42,0.04); box-shadow:var(--soft-shadow); }
.loc-inner { display:flex; gap:18px; align-items:flex-start; }
.loc-info { width:320px; }
.location-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; color:var(--text-dark); font-weight:800; font-size:1.1rem; }
.loc-title { font-weight:800; font-size:1rem; margin-bottom:6px; color:var(--text-dark); }
.loc-sub { color:var(--muted-2); font-weight:700; }

/* map */
.detail-map { flex:1; height:420px; border-radius:10px; border:1px solid rgba(15,23,42,0.04); box-shadow:0 8px 26px rgba(2,6,23,0.06); }

/* custom marker pin style (flat pin) */
.custom-pin {
  width: 28px;
  height: 36px;
  position: relative;
  transform: translate(-50%, -100%);
  cursor: pointer;
}
.custom-pin .pin-body {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  background: linear-gradient(180deg, #ffb020, #ff7a59);
  box-shadow: 0 8px 18px rgba(255,122,89,0.18);
  border: 2px solid rgba(255,255,255,0.95);
  display:block;
  margin: 0 auto;
}
.custom-pin .pin-tip {
  position:absolute;
  left:50%;
  bottom:-8px;
  transform:translateX(-50%) rotate(45deg);
  width:12px;
  height:12px;
  background: linear-gradient(180deg, #ffb020, #ff7a59);
  border-radius:2px;
  border:2px solid rgba(255,255,255,0.95);
  box-shadow: 0 8px 18px rgba(255,122,89,0.14);
}

/* popup glass style (scoped) */
.map-popup {
  min-width:220px;
  background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(255,255,255,0.75));
  border-radius:10px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,0.18);
  box-shadow: 0 12px 30px rgba(2,6,23,0.12);
  backdrop-filter: blur(6px) saturate(120%);
  color:var(--text-dark);
  font-weight:700;
}
.map-popup .mp-title { font-weight:800; margin-bottom:4px; }
.map-popup .mp-sub { color:var(--muted-2); font-weight:700; font-size:0.95rem; }

/* reviews */
.reviews-container { margin-top:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px; }
.reviews-list, .reviews-side { background:var(--bg-card); border-radius:12px; padding:12px; border:1px solid rgba(15,23,42,0.04); box-shadow:var(--soft-shadow); }
.rating-summary { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
.avg-score { font-size:2.0rem; font-weight:800; color:var(--text-dark); }
.avg-meta { color:var(--muted-2); font-weight:700; }
.rating-bar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.rating-bar .label { width:26px; text-align:right; color:var(--muted-2); font-weight:700; }
.rating-bar .track { height:8px; flex:1; background: rgba(15,23,42,0.05); border-radius:999px; overflow:hidden; }
.rating-bar .fill { height:100%; background: linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%; transition: width .7s ease; border-radius:999px; }
.rating-count { width:40px; text-align:right; color:var(--muted-2); font-weight:700; }

/* review card */
.review-card { display:flex; gap:12px; align-items:flex-start; padding:12px; border-radius:10px; border:1px solid rgba(15,23,42,0.03); background:linear-gradient(180deg,#fff,#fbfcfe); margin-bottom:10px; }
.rev-avatar { width:46px; height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; background: linear-gradient(90deg,#eef2ff,#e9f0ff); color:#0f172a; }
.rev-body { flex:1; }
.rev-head { display:flex; justify-content:space-between; gap:12px; align-items:start; }
.rev-author { font-weight:800; color:var(--text-dark); }
.rev-date { color:var(--muted-2); font-weight:700; font-size:0.9rem; }
.rev-text { margin-top:8px; color:#334155; line-height:1.5; }

/* review form */
.review-form { display:flex; flex-direction:column; gap:8px; }
.stars-input { display:flex; gap:6px; align-items:center; }
.stars-input input { display:none; }
.stars-input label { font-size:22px; cursor:pointer; color: rgba(2,6,23,0.12); transition: transform .12s ease, color .12s ease; }
.stars-input label:hover { color:#fbbf24; transform:translateY(-4px); }
.stars-input input:checked ~ label,
.stars-input label.active { color:#fbbf24; transform:translateY(-2px); }
.textarea { min-height:110px; padding:10px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); resize:vertical; font-size:0.95rem; color:var(--text-dark); }
.char-count { text-align:right; color:var(--muted-2); font-weight:700; font-size:0.9rem; }
.submit-btn { margin-top:6px; background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0f172a; padding:10px 12px; border-radius:10px; border:none; font-weight:900; box-shadow:var(--deep-shadow); cursor:pointer; }
.submit-btn:disabled { opacity:0.6; cursor:not-allowed; box-shadow:none; transform:none; }

/* Scoped Buttons (Navbar safe) */
.show-btn-primary{
  background: linear-gradient(90deg,var(--accent), var(--accent-2));
  color:#0f172a;
  padding:10px 16px;
  border-radius:12px;
  border:none;
  font-weight:800;
  display:inline-flex;
  gap:10px;
  align-items:center;
  text-decoration:none;
  box-shadow:0 10px 30px rgba(255,176,32,0.14);
}

.show-btn-outline{
  background:#fff;
  border:1px solid rgba(15,23,42,0.06);
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  display:inline-flex;
  gap:8px;
  align-items:center;
  color:var(--text-dark);
}

.show-btn-ghost{
  background:#fff4f4;
  border:1px solid #fca5a5;
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  color:#b91c1c;
  display:inline-flex;
  gap:8px;
  align-items:center;
}

/* responsive */
@media (max-width: 1100px) {
  .top-card { grid-template-columns: 1fr; }
  .loc-inner { flex-direction:column; }
  .detail-map { height:320px; }
  .reviews-container { grid-template-columns: 1fr; }
  .detail-page { padding:12px; }
  .right-column { order:2; }
}
  /* =========================
   GLOBAL SAFETY FIXES
========================= */
*{
  box-sizing:border-box;
}

.detail-page{
  width:100%;
  overflow-x:hidden;
}

/* =========================
   TOP CARD RESPONSIVE
========================= */
@media (max-width: 1024px){
  .top-card{
    grid-template-columns:1fr;
    padding:14px;
  }

  .left-column{
    order:1;
  }

  .right-column{
    order:2;
  }
}

/* =========================
   HERO IMAGE FIX
========================= */
@media (max-width: 768px){
  .hero-image{
    min-height:240px;
  }

  .hero-image img{
    height:240px;
  }
}

@media (max-width: 480px){
  .hero-image{
    min-height:200px;
  }

  .hero-image img{
    height:200px;
  }
}

/* =========================
   TITLE + META
========================= */
@media (max-width: 640px){
  .listing-title{
    font-size:1.25rem;
    line-height:1.3;
  }

  .listing-sub{
    font-size:.85rem;
    gap:6px;
  }

  .price-row{
    flex-wrap:wrap;
  }

  .price-value{
    font-size:1.25rem;
  }
}

/* =========================
   AMENITIES RESPONSIVE
========================= */
@media (max-width: 768px){
  .amenities{
    flex-wrap:nowrap;
    overflow-x:auto;
    padding-bottom:6px;
  }

  .amenity{
    flex-shrink:0;
    white-space:nowrap;
  }
}

/* =========================
   ACTION BUTTONS
========================= */
@media (max-width: 640px){
  .actions{
    flex-direction:column;
  }

  .actions a,
  .actions button,
  .actions form{
    width:100%;
  }

  .show-btn-primary,
  .show-btn-outline,
  .show-btn-ghost{
    width:100%;
    justify-content:center;
  }
}

/* =========================
   LOCATION / MAP
========================= */
@media (max-width: 900px){
  .loc-inner{
    flex-direction:column;
  }

  .loc-info{
    width:100%;
  }

  .detail-map{
    width:100%;
    height:300px;
  }
}

@media (max-width: 480px){
  .detail-map{
    height:240px;
  }
}

/* =========================
   REVIEWS LAYOUT
========================= */
@media (max-width: 1100px){
  .reviews-container{
    grid-template-columns:1fr;
  }

  .reviews-side{
    order:-1;
  }
}

/* =========================
   REVIEW CARD
========================= */
@media (max-width: 600px){
  .review-card{
    flex-direction:column;
  }

  .rev-head{
    flex-direction:column;
    align-items:flex-start;
  }

  .rev-avatar{
    width:40px;
    height:40px;
    font-size:.9rem;
  }
}

/* =========================
   REVIEW FORM
========================= */
@media (max-width: 480px){
  .stars-input{
    gap:4px;
  }

  .stars-input label{
    font-size:20px;
  }

  .textarea{
    min-height:90px;
  }

  .submit-btn{
    width:100%;
  }
}

/* =========================
   QUICK META
========================= */
@media (max-width: 480px){
  .quick-meta{
    gap:6px;
  }

  .quick-pill{
    font-size:.8rem;
    padding:6px 10px;
  }
}

/* ===== MAP HARD FIX ===== */
.detail-map{
  width:100%;
  min-height:360px;
  height:360px;
  display:block;
  position:relative;
}

@media (max-width: 768px){
  .detail-map{
    min-height:300px;
    height:300px;
  }
}

@media (max-width: 480px){
  .detail-map{
    min-height:240px;
    height:240px;
  }
}


</style>
<div class="detail-page">

  <!-- Top card -->
  <div class="top-card">
    <!-- Left -->
    <div class="left-column">
      <div class="hero-image" role="img" aria-label="<%= listing.title %>">
        <img src="<%= listing.image?.url || '/images/fallback.jpg' %>" alt="<%= listing.title %>">
        <% if (listing.topPick) { %>
          <div class="badge-top"><i class="fa-solid fa-star"></i> Top pick</div>
        <% } %>
      </div>

      <div class="quick-meta" aria-hidden="true">
        <div class="quick-pill"><i class="fa-solid fa-door-open"></i> <%= listing.guests || 1 %> guests</div>
        <div class="quick-pill"><i class="fa-solid fa-bed"></i> <%= listing.bedrooms || '-' %> beds</div>
        <div class="quick-pill"><i class="fa-solid fa-bath"></i> <%= listing.bathrooms || '-' %> baths</div>
      </div>
    </div>

    <!-- Right -->
    <div class="right-column">
      <div class="title-row">
        <h2 class="listing-title"><i class="fa-solid fa-hotel me-2"></i> <%= listing.title %></h2>
        <div class="listing-sub">
          <div><i class="fa-solid fa-user me-1"></i> <strong><%= listing.owner?.username || 'Unknown' %></strong></div>
          <div><i class="fa-solid fa-location-dot me-1"></i> <%= listing.location %>, <%= listing.country %></div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="display:flex; gap:8px; align-items:center;">
              <div style="background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0f172a; padding:6px 8px; border-radius:8px; font-weight:900;"><i class="fa-solid fa-star"></i></div>
              <div style="font-weight:800;"><%= avgRounded %></div>
            </div>
            <div style="color:var(--muted-2); font-weight:700;">(<%= reviewCount %>)</div>
          </div>
        </div>

        <div class="price-row">
          <div class="price-value">â‚¹ <%= Number(listing.price).toLocaleString("en-IN") %></div>
          <div class="price-sub">/ night</div>
        </div>
      </div>

      <div class="desc"><%= listing.description %></div>

      <% if (listing.amenities && listing.amenities.length) { %>
        <div class="amenities" aria-label="Amenities">
          <% listing.amenities.forEach(a => { %>
            <div class="amenity"><i class="fa-solid fa-check"></i> <%= a.charAt(0).toUpperCase() + a.slice(1) %></div>
          <% }) %>
        </div>
      <% } %>

      <div class="actions" role="group" aria-label="Actions">
        <% const isOwner = currentUser && listing.owner && String(currentUser._id) === String(listing.owner._id); %>
        <% const isAdmin = currentUser && currentUser.role === 'admin'; %>

        <% if (isOwner || isAdmin) { %>
          <a href="/listings/<%= listing._id %>/edit" class="show-btn-outline"><i class="fa-solid fa-pen me-1"></i> Edit</a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" style="display:inline;">
            <button class="show-btn-ghost" type="submit" onclick="return confirm('Delete listing?')"><i class="fa-solid fa-trash me-1"></i></button>
          </form>
        <% } else if (currentUser) { %>
          <a href="/bookings/listings/<%= listing._id %>/premium-book" class="show-btn-primary">
            <i class="fa-solid fa-credit-card"></i> Book Now
          </a>

          <button id="saveBtn" data-id="<%= listing._id %>" 
                  class="show-btn-outline <%= currentUser.savedListings?.includes(String(listing._id)) ? 'active' : '' %>">
            <i class="fa-solid fa-heart"></i>
            <span class="save-text"><%= currentUser.savedListings?.includes(String(listing._id)) ? 'Saved' : 'Save' %></span>
          </button>

        <% } else { %>
          <a href="/login" class="show-btn-primary"><i class="fa-solid fa-right-to-bracket"></i> Login to Book</a>
        <% } %>
      </div>

    </div>
  </div>

  <!-- Location / Map block with info column -->
  <% if (listing.geometry?.coordinates) { %>
    <div class="location-block" aria-labelledby="locationHeading">
      <div class="loc-inner">
        <div class="loc-info">
          <div class="location-header" id="locationHeading"><i class="fa-solid fa-map-location-dot"></i> Location</div>
          <div class="loc-address">
            <div class="loc-title"><strong><%= listing.title %></strong></div>
            <div class="loc-sub"><i class="fa-solid fa-location-dot me-1"></i> <%= listing.location %>, <%= listing.country %></div>
            <% if (listing.address) { %>
              <div class="loc-full" style="color:var(--muted-2); margin-top:8px;"><%= listing.address %></div>
            <% } %>
          </div>
        </div>

        <div id="map" class="detail-map" data-lng="<%= listing.geometry.coordinates[0] %>" data-lat="<%= listing.geometry.coordinates[1] %>"></div>
      </div>
    </div>
  <% } %>

  <!-- Reviews -->
  <div class="reviews-container">
    <div class="reviews-list" aria-live="polite">
      <div class="rating-summary">
        <div>
          <div class="avg-score"><%= avgRounded %></div>
          <div class="avg-meta">Average rating</div>
        </div>
        <div style="flex:1;">
          <% [5,4,3,2,1].forEach((s,i) => { 
               const cnt = ratingCounts[i];
               const pct = reviewCount ? Math.round((cnt / reviewCount) * 100) : 0;
          %>
            <div class="rating-bar">
              <div class="label"><%= s %></div>
              <div class="track"><div class="fill" style="width:<%= pct %>%"></div></div>
              <div class="rating-count"><%= cnt %></div>
            </div>
          <% }) %>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:800; color:var(--muted);">Reviews</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label for="sortReviews" class="visually-hidden">Sort reviews</label>
          <select id="sortReviews" class="sort-select" aria-label="Sort reviews" style="padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); font-weight:700;">
            <option value="newest">Newest</option>
            <option value="highest">Highest rating</option>
            <option value="lowest">Lowest rating</option>
          </select>
        </div>
      </div>

      <div id="reviewsContainer">
        <% if (!reviews.length) { %>
          <p style="color:var(--muted-2); font-weight:700;">No reviews yet â€” be the first.</p>
        <% } else { %>
          <% reviews.slice().reverse().forEach(review => { %>
            <div class="review-card" data-rating="<%= review.rating %>" data-created="<%= new Date(review.createdAt).getTime() %>">
              <div class="rev-avatar"><%= (review.author && review.author.username) ? review.author.username.charAt(0).toUpperCase() : 'G' %></div>
              <div class="rev-body">
                <div class="rev-head">
                  <div>
                    <div class="rev-author">@<%= review.author?.username || 'Guest' %></div>
                    <% if (review.title) { %><div style="color:var(--muted-2); font-weight:700;"><%= review.title %></div><% } %>
                  </div>
                  <div style="text-align:right;">
                    <div class="rev-date"><%= new Date(review.createdAt).toLocaleDateString("en-IN") %></div>
                    <div class="rev-stars" aria-hidden="true" style="margin-top:6px;">
                      <% for(let i=0;i<review.rating;i++){ %><span style="color:#fbbf24; font-weight:800;">â˜…</span><% } %>
                    </div>
                  </div>
                </div>

                <div class="rev-text"><%= review.comment %></div>

                <div style="margin-top:8px;">
                  <% if (currentUser && String(review.author?._id) === String(currentUser._id)) { %>
                    <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" style="display:inline;">
                      <button type="submit" class="show-btn-outline" style="padding:6px 10px; font-weight:700;">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- Side: new review + quick stats -->
    <aside class="reviews-side" aria-labelledby="writeReviewHeading">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div>
          <div id="writeReviewHeading" style="font-weight:900; font-size:1.05rem;">Write a review</div>
          <div style="color:var(--muted-2); font-weight:700;">Share your honest experience</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900; font-size:1.2rem;"><%= avgRounded %></div>
          <div style="color:var(--muted-2); font-weight:700;"><%= reviewCount %> total</div>
        </div>
      </div>

      <% if (currentUser) { %>
        <form id="reviewForm" class="review-form" action="/listings/<%= listing._id %>/reviews" method="POST" novalidate>
          <div style="font-weight:800; color:var(--muted-2); margin-bottom:6px;">Your rating</div>
          <div class="stars-input" role="radiogroup" aria-label="Your rating">
            <% for(let i=5;i>=1;i--){ %>
              <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>">
              <label for="star<%= i %>" title="<%= i %> stars">â˜…</label>
            <% } %>
          </div>

          <textarea id="reviewText" name="review[comment]" class="textarea" placeholder="Tell other travellers about your stay..." maxlength="800" required></textarea>
          <div class="char-count"><span id="charsLeft">800</span> characters left</div>

          <button id="submitReviewBtn" type="submit" class="submit-btn" disabled>Submit review</button>
        </form>
      <% } else { %>
        <div style="padding:12px; border-radius:8px; background:linear-gradient(180deg,#fff,#fff); border:1px solid rgba(15,23,42,0.04);">
          <div style="font-weight:800; margin-bottom:8px;">Login to leave a review</div>
          <a href="/login" class="show-btn-primary" style="display:inline-flex; align-items:center; gap:8px;"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
        </div>
      <% } %>
    </aside>
  </div>

</div>

<!-- Maplibre -->
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>


<script>
  // Map + glass popup on hover (Pin marker) + map layout tweaks
  window.addEventListener('load', () => {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;

    const lng = +mapEl.dataset.lng;
    const lat = +mapEl.dataset.lat;

    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets/style.json?key=<%= mapToken %>`,
      center: [lng, lat],
      zoom: 12
    });
    map.addControl(new maplibregl.NavigationControl());
    map.on('load', () => {
    map.resize();   // ðŸ”¥ fix
      });

      window.addEventListener('resize', () => {
        map.resize();   // ðŸ”¥ fix
      });

    // create pin element
    const pin = document.createElement('div');
    pin.className = 'custom-pin';
    pin.innerHTML = '<span class="pin-body"></span><span class="pin-tip"></span>';

    // popup HTML (glass)
    const popupHtml = document.createElement('div');
    popupHtml.className = 'map-popup';
    popupHtml.innerHTML = `
      <div class="mp-title"><strong><%= (listing.title || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') %></strong></div>
      <div class="mp-sub"><i class="fa-solid fa-location-dot"></i> <%= (listing.location || '') %>, <%= (listing.country || '') %></div>
    `;

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: [0, -18]
    }).setDOMContent(popupHtml);

    const marker = new maplibregl.Marker({ element: pin, anchor: 'bottom' })
      .setLngLat([lng, lat])
      .addTo(map);

    // Hover interactions
    pin.addEventListener('mouseenter', () => popup.addTo(map).setLngLat([lng, lat]));
    pin.addEventListener('mouseleave', () => popup.remove());

    // Click to toggle popup
    pin.addEventListener('click', () => {
      if (popup._map) popup.remove();
      else popup.addTo(map).setLngLat([lng, lat]);
    });

    // lift map center a bit so popup not clipped
    map.on('load', () => {
      map.easeTo({ center: [lng, lat], offset: [0, -80], duration: 700 });
    });
  });

  // Save (toggle) button
  document.addEventListener('DOMContentLoaded', () => {
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const id = saveBtn.dataset.id;
        try {
          const res = await fetch(`/listings/${id}/save`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) {
            if (res.status === 401) return window.location = '/login';
            throw new Error('Save failed');
          }
          const data = await res.json();
          if (data.saved) {
            saveBtn.classList.add('active');
            const span = saveBtn.querySelector('.save-text');
            if (span) span.textContent = 'Saved';
          } else {
            saveBtn.classList.remove('active');
            const span = saveBtn.querySelector('.save-text');
            if (span) span.textContent = 'Save';
          }
        } catch (err) {
          console.error(err);
        }
      });
    }

    // Reviews: client-side sort
    const sortSelect = document.getElementById('sortReviews');
    const reviewsContainer = document.getElementById('reviewsContainer');
    if (sortSelect && reviewsContainer) {
      sortSelect.addEventListener('change', () => {
        const mode = sortSelect.value;
        const nodes = Array.from(reviewsContainer.querySelectorAll('.review-card'));
        let sorted = nodes.slice();
        if (mode === 'highest') sorted.sort((a,b) => +b.dataset.rating - +a.dataset.rating);
        else if (mode === 'lowest') sorted.sort((a,b) => +a.dataset.rating - +b.dataset.rating);
        else sorted.sort((a,b) => +b.dataset.created - +a.dataset.created);
        reviewsContainer.innerHTML = '';
        sorted.forEach(n=>reviewsContainer.appendChild(n));
      });
    }

    // Review form UX (enable/disable submit, char count, star hover)
    const reviewForm = document.getElementById('reviewForm');
    const reviewText = document.getElementById('reviewText');
    const submitBtn = document.getElementById('submitReviewBtn');
    const charsLeft = document.getElementById('charsLeft');
    // support both class names if used elsewhere
    const starInputs = Array.from(document.querySelectorAll('.stars-input input, .rating-stars input, .rating-stars input[type="radio"]'));

    function validateReviewInputs() {
      const txt = reviewText ? reviewText.value.trim() : '';
      const star = starInputs.find(i=>i.checked);
      if (submitBtn) submitBtn.disabled = !(txt.length >= 10 && star);
    }

    if (reviewText) {
      reviewText.addEventListener('input', () => {
        const left = 800 - reviewText.value.length;
        if (charsLeft) charsLeft.textContent = left;
        validateReviewInputs();
      });
    }
    starInputs.forEach(si => si.addEventListener('change', validateReviewInputs));

    // star label hover (visual)
    const starLabels = document.querySelectorAll('.stars-input label, .rating-stars label');
    starLabels.forEach((lbl) => {
      lbl.addEventListener('mouseenter', () => {
        let el = lbl;
        el.classList.add('active');
        while (el = el.previousElementSibling) { if (el.tagName === 'LABEL') el.classList.add('active'); }
      });
      lbl.addEventListener('mouseleave', () => {
        starLabels.forEach(l => l.classList.remove('active'));
      });
    });

    // Ensure form actually posts (and show optimistic preview)
    if (reviewForm) {
      reviewForm.addEventListener('submit', (e) => {
        const txt = reviewText ? reviewText.value.trim() : '';
        const star = starInputs.find(i=>i.checked);
        if (!star || txt.length < 10) {
          e.preventDefault();
          alert('Please provide a rating and at least 10 characters in the review.');
          return false;
        }
        // optimistic preview (non-blocking)
        try {
          const temp = document.createElement('div');
          temp.className = 'review-card';
          const authorChar = "<%= (currentUser && currentUser.username) ? currentUser.username.charAt(0).toUpperCase() : 'U' %>";
          const authorName = "<%= (currentUser && currentUser.username) ? currentUser.username : 'You' %>";
          const now = new Date().toLocaleDateString('en-IN');
          const stars = 'â˜…'.repeat(+document.querySelector('.stars-input input:checked, .rating-stars input:checked')?.value || 0);
          temp.innerHTML = `
            <div class="rev-avatar">${authorChar}</div>
            <div class="rev-body">
              <div class="rev-head">
                <div><div class="rev-author">@${authorName}</div></div>
                <div style="text-align:right;"><div class="rev-date">${now}</div><div class="rev-stars" style="margin-top:6px;">${stars}</div></div>
              </div>
              <div class="rev-text">${escapeHtml(txt)}</div>
            </div>
          `;
          const rc = document.getElementById('reviewsContainer');
          if (rc) rc.prepend(temp);
        } catch (err) { /* ignore optimistic error */ }
        // allow submit to proceed to server (no preventDefault)
      });
    }

    // helper escape
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // animate rating bars fill
    setTimeout(()=> {
      document.querySelectorAll('.rating-bar .fill').forEach(el => {
        const w = el.style.width || '0%';
        el.style.width = '0%';
        setTimeout(()=> el.style.width = w, 60);
      });
    }, 150);

  });
</script>
